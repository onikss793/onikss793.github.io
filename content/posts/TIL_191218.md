---
title: 'TIL_191218'
date: '2019.12.18'
template: 'post'
draft: false
slug: '/posts/til_191218/'
category: 'TIL'
tags:
  - 'uploading CSV'
description: 'How to upload csv file in node.js'
socialImage: ''
---

#### 개요

지난 포스트에서 사용했었던 csv 파일 업로등 방법을 실제로 사용하다보니 문제가 생겨 재포스팅한다.

문제는 stream을 사용하기 때문인지, 요청을 처리하는 속도의 편차가 매우 심하다는 것이었다.

0.5초만에 된다거나, 수 초만에 된다거나, 아니면 아예 안 되는 경우도 있었다.

#### 해결 방법

우선 `multer`를 미들웨어로 사용해서 로컬에 저장했는데,  
`multer.diskStorage`를 사용하여 저장 위치와 파일 이름을 지정했다.

```js
const storage = multer.diskStorage({
  destination: function(req, file, cb) {
    cb(null, 'csv/');
  },
  filename: function(req, file, cb) {
    cb(null, file.originalname);
  }
});
const upload = multer({ storage });
```

`multer`는 미들웨어로 작동하기 때문에 아래와 같이 내가 사용하는 controller 전에 실행하게 했다.

```js
router.post('/', upload.single('data'), uploadCsv);
```

controller에서는 저장된 csv파일을 읽는 작업을 했다.

먼저는 readFile을 사용해서 csv파일을 읽으려했지만 데이터가 Buffer이었기 때문에 읽을 수가 없었다.  
Buffer는 Chrome V8 엔진 밖에 위차한 고정된 크기의 메모리 덩어리이다.  
마치 데이터의 바이트를 나타내는 정수가 담겨있는 배열이라고 생각하면 쉽다.  
Buffer는 stream과 깊은 연관이 있는데, stream이 데이터를 더 빨리 소화할 수 있는 형태로 되어 있기 때문이다.

이를 해결하기 위해서 readFile 메소드에 인코딩하는 방식인 'UTF-8'를 추가했더니 쉽표로 구분된 긴 문자열이 나왔다.

쉼표와 `\r\n`을 사용해서 행과 열을 나누었지만 또 문제가 발생했다. 하나의 셀에 쉽표로 분리된 두 개의 값이 있는 경우, 정확한 셀 구분을 할 수 없다는 것이었다.

복잡한 반복문과 조건문을 사용하여 해결할 수도 있었겠지만, 라이브러리의 도움을 받는 편이 낫다고 판단했다.

사용한 라이브러리는 `csvtojson`이다. 한 줄로 csv 파일을 json 형태로 변환하는데 성공했다.

```js
const result = await csvtojson().fromFile(req.file.path);
```

한 가지 배운 것이 있다면, 무작정 라이브러리에 의존하는 것은 쓸데없이 프로젝트를 무겁게 만든다는 단점이 있지만, 조금 복잡해진다 싶으면 좋은 라이브러리를 사용하는 것이 훨씬 효과적이라는 것이다.
