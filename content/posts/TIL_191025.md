---
title: "TIL 191025"
date: "2019.10.25"
template: "post"
draft: false
slug: "/posts/til_191025/"
category: "TIL"
tags:
  - "TIL"
  - "Django"
  - "React Native"
description: "What I learned today"
socialImage: ""
---

#### **Authentification**

Authentification이란 요청을 보내는 사용자를 신뢰할 수 있는지, 그 권한 여부를 판단하는 메커니즘을 이야기한다.

django는 기본적으로 django.auth를 제공한다. 하지만 그 원리를 조금 더 익혀보고자 bcrypt와 jwt를 이용해 인증과 인가를 연습해보려 한다.

우선 View에서 bcrypt와 jwt를 사용하려면 install을 먼저 해주어야 한다.

```py
pip install bcrypt
pip install jwt
```

위 명령어를 이용하면 설치할 수 있다. 참고로 프로젝트의 가상환경 내에서 설치해야 한다는 것을 잊지 말아야 한다.

**회원가입**

기본적인 회원가입에 필요한 데이터 중, 비밀번호는 반드시 암호화해서 데이터베이스에 저장되어야 한다. 먼저 받은 비밀번호를 byte로 인코딩한다. byte로 인코딩된 값은 `b'sss` 로 표시된다.

```py
byte_pw       = bytes(signup_data["password"])
```

그리고 byte된 비밀번호를 hashing 한다.

```py
hashed_pw     = bcrypt.hashpw(byte_pw, bcrypt.gensalt())
```

까먹지 안아야 하는 점은 데이터 베이스에 저장할 때는 디코딩('utf-8')해서 저장한다는 점이다.

```py
Users(
      name      = signup_data["name"],
      user_name = signup_data["user_name"],
      password  = hashed_pw.decode("utf-8")
).save()
```

**로그인**

로그인을 할 때는 bcrypt에 있는 checkpw()라는 메서드를 사용한다. 인자로는 `checkpw(입력한 비밀번호, db에 있는 비밀번호)` 이렇게 받는데 주의할 점은 입력한 비밀번호, db에 있는 비밀번호 모두 'utf-8' 방식으로 인코딩해야 한다는 것이다.

```py
try:
    user = Users.objects.get(user_name=login_data["user_name"])
    if bcrypt.checkpw(password.encode("utf-8"), user.password.encode("utf-8")):
```

위처럼 checkpw 메서드의 인자는 반드시 인코딩한 값이 들어가야 한다.
비밀번호가 일치했다면 프론트앤드 서버로 웹토큰을 발행해주어야 한다.

```py
    payload           = {"user_id": user.id, "exp":"Oct 25 2019 18:29:52 GMT+0900"}
    encryption_secret = "secret"
    algorithm         = "HS256"
    encoded           = jwt.encode(payload, encryption_secret, algorithm=algorithm)
```

jwt를 사용해서 인코딩을 할 수 있다. 위의 내용을 이해하기 위해서는 먼저 jwt의 구조를 알아야 한다.  
각각은 . 으로 구분되어 있다. 먼저 1번으로 Token type(JWT)이 있다. 해시알고리즘을 지정하는데, Base64URL로 코드화된다. 2번으로 payload가 BaseURL로 코드화되어 적혀있다. 3번째로 signature, JWT가 원본 그대로라는 것을 확인할 때 사용되는 부분으로써, Base64URL코드화된 header와 payload 그리고 secret key를 헤더에 지정된 알고리즘(HS256)으로 암호화되어 전송된다.

jwt.encode에는 총 3개의 인자를 받을 수 있는데 첫번째는 payload, 즉 담을 내용을 말한다. user.id를 넣을 수 있다. 두번째는 encryption_secret, 다시 말해 암호화할 secret key를 말한다. 세번째로 암호화할 때 사용할 알고리즘을 지정한다. 로그인 후, 프론트엔드 서버와 토큰을 주고 받으며 통신하는 부분은 다음 편에 이어서 적도록 하겠다. 아래는 장고 서버와 다른 서버가 통신할 때 필요한 django cors 기본 세팅이다. 참고로 모든 서버에 오픈되어 있다.

```py
CORS_ALLOW_HEADERS = [
      'accept',
      'accept-encoding',
      'authorization',
      'content-type',
      'dnt',
      'origin',
      'user-agent',
      'x-csrftoken',
      'x-requested-with',
]

CORS_ORIGIN_ALLOW_ALL = True

CORS_ALLOW_CREDENTIALS = True
```

### **React Native Navigation**

Drawer Navigation 왼쪽에 navigation 바가 생긴다. (옷장 문여는 것 같아서 생긴 이름인 것 같다).

bottomTabNavigation 화면 하단에 navigation 바가 생긴다.

```js
HomeStack.navigationOptions = {
  tabBarLabel: "Home",
  tabBarIcon: ({ focused }) => (
    <TabBarIcon
      focused={focused}
      name={
        Platform.OS === "ios"
          ? `ios-information-circle${focused ? "" : "-outline"}`
          : "md-information-circle"
      }
    />
  )
};
```

`` `ios-information-circle${focused ? '' : '-outline'}` `` => React Native에서 제공하는 기본적인 icon들이 있는데(expo vetor icons) 이것들을 이름만 바꾸면 이용할 수 있다.

로그인하는 시점에서 백엔드 서버에서 토큰을 발행 받는다. 그리고 브라우저의 ls, ss ck에 각각 기획의 특성에 맞게 저장한다. 그리고 로그인 상태에서 하는 액션에 대해 api 요청을 보낼 때마다 header에 토큰을 담아서 보내, 백앤드 서버에서 사용자를 구분할 수 있도록 한다.
Authorization 이라는 key에 담아서 토큰을 보낸다.

백앤드 서버, 프론트 앤드의 서버가 각각 필요하다. 백앤드 서버의 ip주소를 알면 프론트 앤드 서버에서 해당 ip 주소를 통해 api를 호출할 수 있다.  
자바 스크립트는 비동기로 작동하기 때문에 fetch를 하게 되면 응답을 기다리기 전에 다른 함수로 넘어간다. 여기서 then을 쓰게 되면 fetch의 응답을 기다렸다가 then()안에 있는 함수를 실행시킨다.

```js
login = () => {
  fetch("http://localhost:8000/account/login", {
    method: "post",
    body: JSON.stringify({
      user_name: this.state.idValue,
      password: this.state.pwValue
    })
  })
    .then(res => res.json())
    .then(res => {
      const { history } = this.props;
      if (res.message === "success") {
        localStorage.setItem("userToken", res.token);
        history.push("/main");
      } else {
        console.log(res.message);
        //window.location.reload();
      }
    });
};
```

then()안에 있는 json()함수를 사용하면 body에 있는 내용만 json 형태로 변환된다. 그 다음의 then 함수 안에 있는 함수를 통해 원하는 작업을 할 수 있다.  
만약 백앤드 서버에서 200을 보내면 그것을 조건으로 삼아서 로컬 스토리지 등에 토큰을 저장하고 메인 페이지(다음 페이지)로 넘어갈 수 있다.
